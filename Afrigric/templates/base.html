<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ translations.get('app_title', 'AfriGric - Maize Problem Solver') }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/6.6.6/css/flag-icons.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('home') }}">
                <img src="{{ url_for('static', filename='images/default_maize.jpg') }}" alt="AfriGric Logo" style="height:32px;width:32px;border-radius:50%;margin-right:8px;box-shadow:0 2px 8px rgba(40,167,69,0.12);vertical-align:middle;">
                <span class="fw-bold" style="font-size:1.3rem;letter-spacing:1px;">AfriGric</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                 <ul class="navbar-nav me-auto">
                     <li class="nav-item">
                         <a class="nav-link" href="{{ url_for('home') }}">{{ translations.get('home', 'Home') }}</a>
                     </li>
                     <li class="nav-item">
                         <a class="nav-link" href="{{ url_for('disease_detection') }}">{{ translations.get('disease', 'Disease') }}</a>
                     </li>
                     <li class="nav-item">
                         <a class="nav-link" href="{{ url_for('pest_detection') }}">{{ translations.get('pests', 'Pests') }}</a>
                     </li>
                     <li class="nav-item">
                         <a class="nav-link" href="{{ url_for('nutrient_detection') }}">{{ translations.get('nutrients', 'Nutrients') }}</a>
                     </li>
                     <li class="nav-item">
                         <a class="nav-link" href="{{ url_for('yield_prediction') }}">{{ translations.get('yield_prediction', 'Yield Prediction') }}</a>
                     </li>
                     <li class="nav-item">
                         <a class="nav-link" href="{{ url_for('maize_guide') }}">
                             <i class="fas fa-graduation-cap me-1"></i>{{ translations.get('maize_guide_nav', 'Maize Guide') }}
                         </a>
                     </li>
                 </ul>
                 <ul class="navbar-nav">
                     <li class="nav-item dropdown">
                         <a class="nav-link dropdown-toggle" href="#" id="languageDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                             <i class="fas fa-globe me-1"></i>{{ current_lang.upper() }}
                         </a>
                         <ul class="dropdown-menu" aria-labelledby="languageDropdown">
                             <li><a class="dropdown-item" href="{{ url_for('set_language', lang='en') }}">
                                 <i class="flag-icon flag-icon-us me-2"></i>English
                             </a></li>
                             <li><a class="dropdown-item" href="{{ url_for('set_language', lang='yo') }}">
                                 <i class="flag-icon flag-icon-ng me-2"></i>Yoruba
                             </a></li>
                             <li><a class="dropdown-item" href="{{ url_for('set_language', lang='ha') }}">
                                 <i class="flag-icon flag-icon-ng me-2"></i>Hausa
                             </a></li>
                             <li><a class="dropdown-item" href="{{ url_for('set_language', lang='ig') }}">
                                 <i class="flag-icon flag-icon-ng me-2"></i>Igbo
                             </a></li>
                         </ul>
                     </li>
                 </ul>
             </div>
        </div>
    </nav>

    <div class="container my-5">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        {% block content %}{% endblock %}
    </div>

    <footer class="bg-dark text-white py-4 mt-5 shadow-lg footer">
         <div class="container text-center">
             <div class="mb-2">
                 <img src="{{ url_for('static', filename='images/default_maize.jpg') }}" alt="AfriGric Logo" style="height:36px;width:36px;border-radius:50%;margin-bottom:6px;box-shadow:0 2px 8px rgba(40,167,69,0.12);vertical-align:middle;">
             </div>
             <p class="mb-1 fw-bold" style="font-size:1.1rem;">{{ translations.get('footer_text', 'AfriGric &copy; 2025 - Developed by AbdulAI-X') }}</p>
             <p class="mb-0 text-secondary">{{ translations.get('footer_desc', 'Providing locally-sourced agricultural solutions') }}</p>
         </div>
     </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    {% block scripts %}{% endblock %}

    <!-- Floating Assistant Chat Button -->
    <button id="assistantChatBtn" class="btn btn-success rounded-circle shadow-lg"
        style="position: fixed; bottom: 2rem; right: 2rem; z-index: 1050; width: 64px; height: 64px; display: flex; align-items: center; justify-content: center; font-size: 2.2rem; animation: pulse 2s infinite;"
        aria-label="{{ translations.get('open_assistant', 'Open AfriGric Assistant') }}">
        <i class="fas fa-robot"></i>
    </button>

    <!-- Assistant Chat Modal -->
    <div class="modal fade" id="assistantChatModal" tabindex="-1" aria-labelledby="assistantChatModalLabel" aria-modal="true" role="dialog">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content shadow-lg border-0" style="background: #fff;">
                <div class="modal-header" style="background: linear-gradient(90deg, #28a745 0%, #218838 100%); border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem;">
                    <div class="d-flex align-items-center w-100">
                        <img src="{{ url_for('static', filename='images/default_maize.jpg') }}" alt="Assistant" style="height:44px;width:44px;border-radius:50%;margin-right:14px;box-shadow:0 2px 8px rgba(40,167,69,0.12);">
                        <div>
                            <h5 class="modal-title mb-0 d-flex align-items-center" id="assistantChatModalLabel" style="font-weight:700;letter-spacing:0.5px;">
                                AfriGric Assistant
                            </h5>
                            <small class="text-white-50" style="font-size:0.98em;">Professional Maize Farming Chatbot</small>
                        </div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ translations.get('close', 'Close') }}"></button>
                </div>
                <div class="modal-body" style="background: linear-gradient(120deg, #f8f9fa 0%, #e8f5e9 100%); border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem;">
                    <div id="assistantChatHistory" style="max-height: 400px; overflow-y: auto; margin-bottom: 1rem; background: #fff; border-radius: 1rem; box-shadow: 0 2px 12px rgba(40,167,69,0.07); padding: 1.2rem 1.1rem;">
                        <div class="d-flex mb-3">
                            <img src="{{ url_for('static', filename='images/default_maize.jpg') }}" alt="Assistant" style="height:32px;width:32px;border-radius:50%;margin-right:10px;">
                            <div>
                                <div class="assistant-bubble assistant" style="font-size:1.08em;">
                                    <strong>{{ translations.get('welcome_assistant', 'Welcome to AfriGric Assistant!') }}</strong><br>
                                    {{ translations.get('assistant_intro', 'I am here to provide you with expert maize farming advice, yield tips, and answers to your questions.') }}<br>
                                    <span class="text-muted small">{{ translations.get('try_questions', 'Try: "How do I increase maize yield?" or "Best pest control methods?"') }}</span>
                                </div>
                                <div class="text-muted small mt-1" style="font-size:0.92em;">{{ translations.get('powered_by', 'Powered by AfriGric') }}</div>
                            </div>
                        </div>
                    </div>
                    <form id="assistantChatForm" autocomplete="off" aria-label="Send a message to AfriGric Assistant">
                        <div class="input-group">
                            <input type="text" class="form-control" id="assistantChatInput" placeholder="{{ translations.get('ask_a_question', 'Type your maize farming question...') }}" required aria-label="Type your maize farming question">
                            <button class="btn btn-success" type="submit" aria-label="{{ translations.get('send', 'Send') }}">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <style>
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(40,167,69,0.4); }
        70% { box-shadow: 0 0 0 16px rgba(40,167,69,0.0); }
        100% { box-shadow: 0 0 0 0 rgba(40,167,69,0.0); }
    }
    .assistant-bubble {
        border-radius: 1.2em;
        padding: 0.7em 1.1em;
        margin-bottom: 0.5em;
        font-size: 1.05em;
        box-shadow: 0 2px 8px rgba(40,167,69,0.07);
        word-break: break-word;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .assistant-bubble.assistant {
        background: #f8f9fa;
        color: #218838;
        border: 1px solid #b2dfdb;
    }
    .assistant-bubble.user {
        background: linear-gradient(90deg, #28a745 0%, #218838 100%);
        color: #fff;
        border: 1px solid #218838;
        margin-left: auto;
    }
    .assistant-timestamp {
        font-size: 0.85em;
        color: #adb5bd;
        margin-top: 2px;
        margin-bottom: 0.5em;
        text-align: right;
    }
    </style>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Floating button opens modal
        document.getElementById('assistantChatBtn').addEventListener('click', function() {
            var modal = new bootstrap.Modal(document.getElementById('assistantChatModal'));
            modal.show();
        });

        // Chat form submit
        document.getElementById('assistantChatForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const input = document.getElementById('assistantChatInput');
            const history = document.getElementById('assistantChatHistory');
            const userMsg = input.value.trim();
            if (!userMsg) return;
            // Show user message with avatar and timestamp
            const now = new Date();
            const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            history.innerHTML += `
                <div class="d-flex mb-2 justify-content-end align-items-end">
                    <div>
                        <div class="assistant-bubble user">${userMsg}</div>
                        <div class="assistant-timestamp">${timeStr}</div>
                    </div>
                    <img src="https://ui-avatars.com/api/?name=You&background=28a745&color=fff&rounded=true&size=32" alt="You" style="height:32px;width:32px;border-radius:50%;margin-left:10px;">
                </div>`;
            input.value = '';
            history.scrollTop = history.scrollHeight;

            // Show loading spinner as assistant bubble
            history.innerHTML += `
                <div id="assistantLoading" class="d-flex mb-2 align-items-end">
                    <img src="{{ url_for('static', filename='images/default_maize.jpg') }}" alt="Assistant" style="height:32px;width:32px;border-radius:50%;margin-right:10px;">
                    <div>
                        <div class="assistant-bubble assistant">
                            <span class="spinner-border spinner-border-sm text-success me-2"></span>{{ translations.get('thinking', 'Thinking...') }}
                        </div>
                        <div class="assistant-timestamp">${timeStr}</div>
                    </div>
                </div>`;
            history.scrollTop = history.scrollHeight;

            // Call backend (simulate with delay if no API)
            try {
                const response = await fetch('/api/maize-guidance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: userMsg })
                });
                const data = await response.json();
                document.getElementById('assistantLoading').remove();
                const replyTime = new Date();
                const replyTimeStr = replyTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                if (data.success && data.content) {
                    history.innerHTML += `
                        <div class="d-flex mb-2 align-items-end">
                            <img src="{{ url_for('static', filename='images/default_maize.jpg') }}" alt="Assistant" style="height:32px;width:32px;border-radius:50%;margin-right:10px;">
                            <div>
                                <div class="assistant-bubble assistant">${data.content}</div>
                                <div class="assistant-timestamp">${replyTimeStr}</div>
                            </div>
                        </div>`;
                } else {
                    history.innerHTML += `
                        <div class="d-flex mb-2 align-items-end">
                            <img src="{{ url_for('static', filename='images/default_maize.jpg') }}" alt="Assistant" style="height:32px;width:32px;border-radius:50%;margin-right:10px;">
                            <div>
                                <div class="assistant-bubble assistant bg-warning text-dark">{{ translations.get('no_answer', 'Sorry, I couldn\\\'t find an answer.') }}</div>
                                <div class="assistant-timestamp">${replyTimeStr}</div>
                            </div>
                        </div>`;
                }
            } catch (err) {
                document.getElementById('assistantLoading').remove();
                const errorTime = new Date();
                const errorTimeStr = errorTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                history.innerHTML += `
                    <div class="d-flex mb-2 align-items-end">
                        <img src="{{ url_for('static', filename='images/default_maize.jpg') }}" alt="Assistant" style="height:32px;width:32px;border-radius:50%;margin-right:10px;">
                        <div>
                            <div class="assistant-bubble assistant bg-danger text-white">{{ translations.get('network_error', 'Network error. Please try again.') }}</div>
                            <div class="assistant-timestamp">${errorTimeStr}</div>
                        </div>
                    </div>`;
            }
            history.scrollTop = history.scrollHeight;
        });
    });
    </script>
</body>
</html>